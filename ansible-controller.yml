---

##################################################################################
# This playbook sets up an ansible controller on AWS. This instance is able to   #
# run the experiment playbook and gather the results. It is intended to be used  #
# as a long-running instance where GitHub actions can send commands to, to       #
# trigger experiment runs.                                                       #
##################################################################################

##########################################################################
#   Setup Ansible Controller                                             #
##########################################################################
- name: Create ansible controller
  hosts: localhost
  tasks:

    # Load variables
    - name: Load group variables
      include_role:
        name: load-group-vars
      vars:
        groups_to_load:
          - all

    - name: Manually load variables for ansible_controller
      include_vars:
        file: "{{ external_group_vars_dir }}/ansible_controller/main.yml"

    - name: Setup AWS VPC
      include_role:
        name: experiment-aws-vpc
      vars:
        do_create_vpc: true

    - name: Create AWS EC2 instance for ansible controller
      include_role:
        name: ansible-controller-ec2

- name: Setup ansible controller
  hosts: ~.*_ansible_controller

  tasks:
    - name: Load group variables
      include_role:
        name: load-group-vars
      vars:
        groups_to_load:
          - all
          - ansible_controller

    - name: Configure the EC2 instance for running the AWS Ansible Experiment Suite
      include_role:
        name: ansible-controller-setup
