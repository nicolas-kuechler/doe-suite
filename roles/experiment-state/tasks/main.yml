---

- assert:
    that:
    - exp is defined
    - id is defined
    - expstate == 'load' or expstate == 'save'
    - id == 'new' or id == 'last' or id|int > 0 


- name:
  set_fact:
    exp_name: "{{ exp }}"
    is_init: False

- name: Set exp id from command argument
  set_fact:
    exp_id: "{{ id }}"
  when: id != 'new' and id != 'last' and exp_id is not defined  # continue an experiment run


- name: Find all experiments state of the experiment with `exp`as name
  find:
    paths: "{{ local.exp_state_dir }}"
    patterns: "^{{ exp }}_\\d+$"
    file_type: directory
    use_regex: yes
  register: state_dirs_found
  when: id == 'last' and exp_id is not defined


- name: Select the experiment state with the highest exp_id (i.e., the most recent)
  set_fact:
    exp_id: "{{ state_dirs_found | json_query('files[*].path') | list | sort | last | string | split('_') | last }}"
  when: id == 'last' and exp_id is not defined # continue the last experiment run


- name: Create new exp id + Mark as init
  set_fact:
    is_init: True
    exp_id: "{{ ansible_date_time.epoch }}"
  when: id == 'new' and exp_id is not defined  # init experiment

- debug:
    msg="exp_name={{ exp_name }} exp_id={{ exp_id }}"

- name: Include the experiment variables
  include_vars: experiments/designs/{{ exp_name }}.yml
  when: is_init

- name: Init the experiment state by expanding the base_experiment with the varying params in the experiments
  set_fact:
    exp_runs_ext: "{{ exp_runs_ext | default([]) | union([base_experiment | combine( exp_item, recursive=True ) | combine({ '~FACTORS_LEVEL': { 'args': exp_item } }) ])}}"
    exp_job_ids: []
    exp_job_ids_unfinished: []
    exp_job_ids_pending: []
    exp_job_ids_queued: []
    exp_job_ids_running: []
    exp_job_ids_finished: []
  loop: "{{ factor_levels }}"
  when: is_init
  loop_control:
    loop_var: exp_item

- assert:
    that:
    - not '$FACTOR$' in (exp_runs_ext | string)
    fail_msg: "missing level for at least one factor in the experiment config (i.e., not all '$FACTOR$' are replaced)"
  when: is_init


#################################
# Start Perform CMD Replace

# TODO [nku] at the moment only $CMD$ is replaced, not sure this makes sense in combination with client server setup

- set_fact:
    use_exp_cmd: "{{ '$CMD$' in base_experiment }}" 
  when: is_init

- set_fact:
      exp_runs_ext_wo_cmd: "{{ exp_runs_ext_wo_cmd | default([]) + [my_run | combine({'$CMD$': '-', '~FACTORS_LEVEL': '-'})] | list}}"
  loop: "{{ exp_runs_ext }}"
  loop_control:
    loop_var: my_run
  when: is_init and use_exp_cmd

- name: Create a tmp directory if it does not exist
  ansible.builtin.file:
    path: tmp
    state: directory
    mode: '0755'
  when: is_init and use_exp_cmd

- name: Create tmp command files
  copy:
    dest: tmp/cmd{{ idx }}.yml.j2
    content: "{{ my_run['$CMD$'] }}"
  loop: "{{ exp_runs_ext }}"
  loop_control:
    index_var: idx
    loop_var: my_run
  when: is_init and use_exp_cmd

- name: Apply templating on commands cmds
  set_fact:
    cmds: "{{ cmds | default([]) + [lookup('template', 'tmp/cmd{{ idx }}.yml.j2', variable_start_string='[%', variable_end_string='%]')] }}"
  loop: "{{ exp_runs_ext_wo_cmd }}"
  loop_control:
    index_var: idx
    loop_var: run
  when: is_init and use_exp_cmd
    
- name: set experiments with replaced command
  set_fact:
    exp_runs_ext_tmp: "{{ exp_runs_ext_tmp | default([]) + [my_run | combine({'$CMD$': cmds[idx]})] | list}}"
  loop: "{{ exp_runs_ext }}"
  loop_control:
    index_var: idx
    loop_var: my_run
  when: is_init and use_exp_cmd

- name: Delete content & directory
  file:
    state: absent
    path: tmp/
  when: is_init

- name: update experiments ext variable with replaced cmds
  set_fact:
    exp_runs_ext: "{{ exp_runs_ext_tmp }}"
    exp_runs_ext_tmp: none
  when: is_init and use_exp_cmd

# End Perform CMD Replace
##################################



- name: Create exp directory if it does not exist
  delegate_to: localhost
  file:
    path: "{{ local.exp_state_dir }}/{{ exp_name }}_{{ exp_id }}"
    state: directory
    mode:  0755
  when: is_init

- name: Save the Experiment State in the Run Directory
  delegate_to: localhost
  template:
    src: state.yml.j2
    dest: "{{ local.exp_state_dir }}/{{ exp_name }}_{{ exp_id }}/state.yml"
    mode:  0755
  when: expstate == 'save' or is_init

- name: Load Experiment State
  include_vars: # Be careful: any variables you set with set_fact will not be overwritten with include_vars due to the variable precedence of different sources in Ansible.
    file: "{{ local.exp_state_dir }}/{{ exp_name }}_{{ exp_id }}/state.yml"
    name: state
  when: expstate == 'load' and not is_init
  
- name: Set variables (facts) based on loaded state
  set_fact:
    exp_runs_ext: "{{ state.exp_runs_ext }}"
    exp_job_ids: "{{ state.exp_job_ids }}"
    exp_job_ids_unfinished: "{{ state.exp_job_ids_unfinished }}"
    exp_job_ids_pending: "{{ state.exp_job_ids_pending }}"
    exp_job_ids_queued: "{{ state.exp_job_ids_queued }}"
    exp_job_ids_running: "{{ state.exp_job_ids_running }}"
    exp_job_ids_finished: "{{ state.exp_job_ids_finished }}"
    n_repetitions: "{{ state.n_repetitions }}"
  when: expstate == 'load' and not is_init

- name: Logical check that semantics of job id lists are ok
  assert:
    that:
    # check that exp_job_ids is equal to unfinished + finished
    - exp_job_ids | difference(test_exp_job_ids) | length == 0
    - test_exp_job_ids | difference(exp_job_ids) | length == 0

    # check that exp_jobs_unfinished is correct
    - exp_job_ids_unfinished | difference(test_exp_job_ids_unfinished) | length == 0
    - test_exp_job_ids_unfinished | difference(exp_job_ids_unfinished) | length == 0

    # check that no job_id is in pending, queued, running at the same time
    - test_exp_job_ids_unfinished | unique | length == test_exp_job_ids_unfinished | length 

  vars:
    test_exp_job_ids: "{{ exp_job_ids_unfinished|list + exp_job_ids_finished|list }}"
    test_exp_job_ids_unfinished: "{{ exp_job_ids_pending | list + exp_job_ids_queued | list + exp_job_ids_running | list }}"