---


- name: Collect metadata infos about instance (e.g., instance id)   from within EC2 instance
  amazon.aws.ec2_metadata_facts:
  register: metadata_res

- name: Transfer variables from localhost to host + add info about own experiment, exp_role, etc.
  set_fact:
    exp_name: "{{ tag_assignment[my_instance_id].exp_name }}"
    host_type: "{{ tag_assignment[my_instance_id].host_type }}"
    exp_role: "{{ tag_assignment[my_instance_id].exp_role }}"
    exp_host_type_idx: "{{ tag_assignment[my_instance_id].exp_host_type_idx }}"

    host_types: "{{ hostvars['localhost'].host_types }}"
    exp_facts: "{{ hostvars['localhost'].exp_facts }}" # TODO [nku] maybe we could get rid of this and only use exp_fact

  vars: 
    my_instance_id: "{{ metadata_res.ansible_facts.ansible_ec2_instance_id }}"
    tag_assignment: "{{ hostvars['localhost'].tag_assignment_lst | collect_items2dict(key_name='instance_id') }}"

- name: Transfer remaining variables
  set_fact:
    host_facts: "{{ host_types[host_type][exp_name] }}"
    exp_fact: "{{ exp_facts[exp_name] }}"


# TODO [nku] potentially set for each host an overview of the hosts, their role and how to reach them (public dns)