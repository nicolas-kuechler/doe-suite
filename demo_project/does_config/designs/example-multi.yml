---

# Example for one client server experiment

exp_client_server:
  # each client sends the server a message
  n_repetitions: 3
  #common_roles:
  #  - setup-common
  host_types:
    client:
      n: 2
      check_status: True
      init_role: setup-client
      $CMD$:
        # send messages to the server with nc
        # use exp_host_lst variable to extract ip address from server, the delay `sleep 5` ensures that the server is running when the client sends the message
        - sleep 5 && echo '[% my_run.host_vars.client.msg %] from client 1 ([% my_run.info %])' | netcat -q 1 [% exp_host_lst | json_query("[?host_type=='server'].private_dns_name") | first %] [% my_run.port %]
        # have two commands to distinguish message from client 1 and 2
        - sleep 5 && echo '[% my_run.host_vars.client.msg %] from client 2 ([% my_run.info %])' | netcat -q 1 [% exp_host_lst | json_query("[?host_type=='server'].private_dns_name") | first %] [% my_run.port %]

    server:
      n: 1
      check_status: False
      init_role: setup-server
      # run a single ncat server -> writes all incoming messages to stdout
      $CMD$: ncat -l [% my_run.port %] --keep-open

  base_experiment:
    port: 2807
    info: $FACTOR$
    host_vars:
      client:
        msg: hello server
      server:
        greeting: $FACTOR$

  factor_levels:
    - info: run 0
      host_vars:
        server:
          greeting: hello client
    - info: run 1
      host_vars:
        server:
          greeting: hi client
    - info: run 2
      host_vars:
        server:
          greeting:  good day client